<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature Prioritization Tool</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #C8C4BF 0%, #a8a49f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        body.locked {
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        .login-screen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .login-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
            text-align: center;
        }

        .login-card img {
            height: 48px;
            width: auto;
            margin-bottom: 20px;
        }

        .login-card h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.6em;
        }

        .login-card p {
            color: #666;
            margin-bottom: 25px;
        }

        .login-card .input-group {
            flex-direction: column;
            align-items: stretch;
        }

        .login-card input[type="text"],
        .login-card input[type="password"] {
            margin-bottom: 15px;
        }

        .login-error {
            color: #dc3545;
            margin-top: 10px;
            min-height: 20px;
            font-size: 0.95em;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 40px;
        }

        .app-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .app-logo {
            height: 48px;
            width: auto;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1em;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Page 1 - Feature Entry */
        .feature-input-section {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input[type="text"],
        input[type="password"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #CFFF00;
        }

        select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: white;
            cursor: pointer;
            min-width: 250px;
        }

        select:focus {
            outline: none;
            border-color: #CFFF00;
        }

        select:hover {
            border-color: #CFFF00;
        }

        .respondent-dropdown-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .respondent-dropdown-label {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        button {
            padding: 12px 24px;
            background: #CFFF00;
            color: #333;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
        }

        button:hover {
            background: #b8e600;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .button-secondary {
            background: #C8C4BF;
            color: #333;
        }

        .button-secondary:hover {
            background: #b0ada8;
        }

        .button-success {
            background: #CFFF00;
            color: #333;
        }

        .button-success:hover {
            background: #b8e600;
        }

        .button-danger {
            background: #E799A3;
            padding: 6px 12px;
            font-size: 0.9em;
        }

        .button-danger:hover {
            background: #d6828d;
        }

        .button-info {
            background: #CFFF00;
            color: #333;
        }

        .button-info:hover {
            background: #b8e600;
        }

        .button-chart {
            background: #7c4dff;
            color: #fff;
        }

        .button-chart:hover {
            background: #6535ff;
        }

        .file-upload-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f5f4f3;
            border-radius: 8px;
            border: 2px dashed #CFFF00;
        }

        .file-upload-label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }

        .file-upload-description {
            display: block;
            margin-bottom: 15px;
            color: #666;
            font-size: 0.9em;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-button {
            display: inline-block;
            padding: 10px 20px;
            background: #CFFF00;
            color: #333;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
        }

        .file-upload-button:hover {
            background: #b8e600;
        }

        .file-name-display {
            margin-left: 15px;
            color: #666;
            font-style: italic;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            color: #999;
            font-weight: 600;
        }

        .respondent-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f4f3;
            border-radius: 8px;
            border: 2px solid #CFFF00;
        }

        .respondent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .respondent-label {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .respondent-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .respondent-input {
            flex: 1;
            min-width: 200px;
        }

        .respondent-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .respondent-tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid #CFFF00;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .respondent-tab:hover {
            background: #ffffcc;
        }

        .respondent-tab.active {
            background: #CFFF00;
            color: #333;
            font-weight: 600;
        }

        .respondent-tab-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin-left: 5px;
            line-height: 1;
        }

        .respondent-tab.active .respondent-tab-remove {
            color: white;
        }

        .respondent-tab-remove:hover {
            opacity: 0.7;
        }

        .respondent-info {
            background: #f5f4f3;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #CFFF00;
        }

        .respondent-info-text {
            color: #333;
            font-weight: 600;
        }

        .button-warning {
            background: #CFFF00;
            color: #333;
        }

        .button-warning:hover {
            background: #b8e600;
        }

        .features-list {
            margin-top: 20px;
        }

        .features-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .feature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f5f4f3;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #CFFF00;
            gap: 12px;
            flex-wrap: wrap;
        }

        .feature-item span {
            color: #333;
            font-size: 1em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* Page 2 - Prioritization */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        .prioritization-table {
            width: 100%;
            min-width: 520px;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .prioritization-table thead {
            background: #CFFF00;
            color: #333;
        }

        .prioritization-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
        }

        .prioritization-table th:first-child {
            border-top-left-radius: 8px;
        }

        .prioritization-table th:last-child {
            border-top-right-radius: 8px;
        }

        .prioritization-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .prioritization-table tbody tr {
            background: white;
            transition: background 0.2s;
        }

        .prioritization-table tbody tr:hover {
            background: #f8f9fa;
        }

        .prioritization-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 8px;
        }

        .prioritization-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 8px;
        }

        .feature-name {
            font-weight: 500;
            color: #333;
        }

        input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #CFFF00;
        }

        .priority-cell {
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #f5f4f3;
            border-radius: 8px;
            border-left: 4px solid #CFFF00;
        }

        .chart-page-intro {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.6;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            min-height: 320px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-empty-state {
            text-align: center;
            color: #777;
            padding: 60px 20px;
        }

        .summary h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .summary-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .summary-count {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 25px;
            }

            h1 {
                font-size: 1.6em;
            }

            .respondent-dropdown-container,
            .respondent-input-group,
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .respondent-dropdown-container label,
            .respondent-dropdown-container select,
            .respondent-dropdown-container button,
            .respondent-input-group input,
            .respondent-input-group button,
            .input-group input,
            .input-group button,
            .file-upload-button,
            .button-group button {
                width: 100%;
            }

            select,
            input[type="text"] {
                min-width: 0;
            }

            .respondent-list {
                flex-direction: column;
            }

            .feature-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .feature-item button {
                width: 100%;
            }

            .button-group {
                flex-direction: column;
            }

            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }

            .prioritization-table {
                font-size: 0.9em;
            }

            .prioritization-table th,
            .prioritization-table td {
                padding: 10px 6px;
            }

            input[type="radio"] {
                width: 16px;
                height: 16px;
            }

            .file-name-display {
                margin-left: 0;
                display: block;
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            .app-header {
                justify-content: center;
                margin-bottom: 25px;
            }

            .app-logo {
                height: 40px;
            }

            h1 {
                font-size: 1.4em;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            button {
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body class="locked">
    <div id="login-screen" class="login-screen">
        <div class="login-card">
            <img src="northlane-logo.svg" alt="Northlane logo">
            <h2>Secure Access</h2>
            <p>Please enter your Northlane credentials to continue.</p>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="login-id" placeholder="Enter ID" autocomplete="off" required>
                    <input type="password" id="login-password" placeholder="Enter password" required>
                </div>
                <button type="submit">Unlock Application</button>
            </form>
            <div id="login-error" class="login-error"></div>
        </div>
    </div>
    <div id="app-content" class="container hidden">
        <div class="app-header">
            <img src="northlane-logo.svg" alt="Northlane logo" class="app-logo">
        </div>
        <!-- Page 1: Feature Entry -->
        <div id="page1" class="page active">
            <h1>Feature Prioritization Tool</h1>
            <p class="subtitle">Enter the features you want to discuss during customer interviews</p>

            <div class="respondent-section">
                <div class="respondent-header">
                    <span class="respondent-label">Respondent Management</span>
                </div>
                <div class="respondent-input-group">
                    <input
                        type="text"
                        id="respondentInput"
                        class="respondent-input"
                        placeholder="Enter respondent name..."
                        autocomplete="off"
                    >
                    <button onclick="addRespondent()" class="button-warning">Add New Respondent</button>
                </div>
                <div class="respondent-dropdown-container" style="margin-top: 15px;">
                    <label for="respondentDropdownPage1" class="respondent-dropdown-label">Current Respondent:</label>
                    <select id="respondentDropdownPage1" onchange="handleRespondentDropdownChangePage1()">
                        <option value="">-- Select a respondent --</option>
                    </select>
                    <button onclick="removeCurrentRespondent()" class="button-danger" id="removeRespondentBtn" style="display: none;">Remove</button>
                </div>
            </div>

            <div class="file-upload-section">
                <label class="file-upload-label">Upload Excel File</label>
                <span class="file-upload-description">Upload an Excel file (.xlsx, .xls) with features listed in the first column</span>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                <label for="excelFileInput" class="file-upload-button">Choose Excel File</label>
                <span id="fileNameDisplay" class="file-name-display"></span>
            </div>

            <div class="divider">OR</div>

            <div class="feature-input-section">
                <div class="input-group">
                    <input
                        type="text"
                        id="featureInput"
                        placeholder="Enter a feature (e.g., 'User authentication', 'Export to PDF')..."
                        autocomplete="off"
                    >
                    <button onclick="addFeature()">Add Feature</button>
                </div>
            </div>

            <div class="features-list">
                <div class="features-list-header">
                    <h2 style="color: #333;">Features to Prioritize</h2>
                    <button
                        id="removeAllFeaturesBtn"
                        class="button-danger"
                        onclick="removeAllFeatures()"
                        style="display: none;"
                    >
                        Remove All Features
                    </button>
                </div>
                <div id="featuresList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No features added yet. Start by adding your first feature above.</p>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button
                    onclick="goToPrioritization()"
                    id="nextButton"
                    class="button-success"
                    disabled
                >
                    Next: Prioritize Features ‚Üí
                </button>
            </div>
        </div>

        <!-- Page 2: Prioritization -->
        <div id="page2" class="page">
            <h1>Prioritize Features</h1>
            <p class="subtitle">Select the priority level for each feature</p>

            <div class="respondent-section">
                <div class="respondent-dropdown-container">
                    <label for="respondentDropdown" class="respondent-dropdown-label">Select Respondent:</label>
                    <select id="respondentDropdown" onchange="handleRespondentDropdownChange()">
                        <option value="">-- Select a respondent --</option>
                    </select>
                </div>
            </div>

            <div id="prioritizationContent">
                <!-- Table will be generated by JavaScript -->
            </div>

            <div class="button-group">
                <button onclick="goBackToEntry()" class="button-secondary">‚Üê Back to Features</button>
                <button onclick="exportToExcel()" class="button-info">Export to Excel</button>
                <button onclick="goToChartPage()" class="button-chart">Feature Importance Chart</button>
                <button onclick="showSummary()" class="button-success">View Summary</button>
            </div>

            <div id="summary" class="summary" style="display: none;">
                <!-- Summary will be generated by JavaScript -->
            </div>
        </div>

        <!-- Page 3: Feature Importance Chart -->
        <div id="page3" class="page">
            <h1>Feature Importance Overview</h1>
            <p class="chart-page-intro">
                This stacked bar chart aggregates responses from every respondent. Each bar shows how often a feature was
                classified into each priority category, helping you quickly spot the most critical capabilities.
            </p>

            <div class="chart-wrapper" id="chartWrapper">
                <canvas id="featureImportanceChart"></canvas>
                <div id="chartEmptyState" class="chart-empty-state" style="display: none;">
                    No prioritization data yet. Assign priorities to features to populate this chart.
                </div>
            </div>

            <div class="button-group">
                <button onclick="goBackToPrioritization()" class="button-secondary">‚Üê Back to Prioritization</button>
            </div>
        </div>
    </div>

    <script>
        const VALID_ID = 'NorthlaneApp';
        const VALID_PASSWORD = 'TestNorthFeatures';

        let appUnlocked = false;

        function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }

            const idInput = document.getElementById('login-id');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');

            const enteredId = idInput ? idInput.value.trim() : '';
            const enteredPassword = passwordInput ? passwordInput.value : '';

            if (enteredId === VALID_ID && enteredPassword === VALID_PASSWORD) {
                sessionStorage.setItem('northlaneAppUnlocked', 'true');
                unlockApplication();
                if (errorDiv) {
                    errorDiv.textContent = '';
                }
            } else {
                if (errorDiv) {
                    errorDiv.textContent = 'Invalid ID or password. Please try again.';
                }
                if (passwordInput) {
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
        }

        function unlockApplication() {
            if (appUnlocked) {
                return;
            }

            appUnlocked = true;

            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');

            if (loginScreen) {
                loginScreen.classList.add('hidden');
            }

            if (appContent) {
                appContent.classList.remove('hidden');
            }

            document.body.classList.remove('locked');

            initializeAppData();
        }

        function initializeAppData() {
            loadData();
            renderRespondentList();
            renderFeaturesList();
            updateNextButton();
        }

        window.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const storedUnlock = sessionStorage.getItem('northlaneAppUnlocked');
            if (storedUnlock === 'true') {
                unlockApplication();
            } else {
                const idInput = document.getElementById('login-id');
                if (idInput) {
                    idInput.focus();
                }
            }
        });

        // Data storage - Multi-respondent structure
        let features = [];
        let respondents = []; // Array of {id, name, priorities: {}}
        let currentRespondentId = null;
        let featureImportanceChart = null;

        // Priority options (in order)
        const priorityOptions = [
            { id: 'must', label: '1. Must have' },
            { id: 'should', label: '2. Should have' },
            { id: 'nice', label: '3. Nice to have' },
            { id: 'not', label: '4. Not needed' }
        ];

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('features', JSON.stringify(features));
            localStorage.setItem('respondents', JSON.stringify(respondents));
            localStorage.setItem('currentRespondentId', currentRespondentId);
        }

        // Load data from localStorage
        function loadData() {
            const savedFeatures = localStorage.getItem('features');
            const savedRespondents = localStorage.getItem('respondents');
            const savedCurrentRespondentId = localStorage.getItem('currentRespondentId');

            if (savedFeatures) {
                features = JSON.parse(savedFeatures);
            }
            if (savedRespondents) {
                respondents = JSON.parse(savedRespondents);
            }
            if (savedCurrentRespondentId) {
                currentRespondentId = savedCurrentRespondentId;
            }
        }

        // Get current respondent object
        function getCurrentRespondent() {
            return respondents.find(r => r.id === currentRespondentId);
        }

        // Get current priorities for active respondent
        function getCurrentPriorities() {
            const respondent = getCurrentRespondent();
            return respondent ? respondent.priorities : {};
        }

        // Respondent Management Functions
        function addRespondent() {
            const input = document.getElementById('respondentInput');
            const respondentName = input.value.trim();

            if (respondentName === '') {
                alert('Please enter a respondent name');
                return;
            }

            // Check if respondent name already exists
            if (respondents.some(r => r.name === respondentName)) {
                alert('A respondent with this name already exists');
                return;
            }

            // Create new respondent
            const newRespondent = {
                id: 'resp_' + Date.now(),
                name: respondentName,
                priorities: {}
            };

            respondents.push(newRespondent);
            currentRespondentId = newRespondent.id;

            input.value = '';
            saveData();
            renderRespondentList();
            refreshChartIfActive();
        }

        function switchRespondent(respondentId) {
            currentRespondentId = respondentId;
            saveData();
            renderRespondentList();

            // Refresh the prioritization table if on page 2
            const page2 = document.getElementById('page2');
            if (page2 && page2.classList.contains('active')) {
                renderPrioritizationTable();
                // Hide summary when switching respondents
                const summaryDiv = document.getElementById('summary');
                if (summaryDiv) {
                    summaryDiv.style.display = 'none';
                }
            }
        }

        function removeRespondent(respondentId) {
            const respondent = respondents.find(r => r.id === respondentId);
            if (!respondent) return;

            if (!confirm(`Remove respondent "${respondent.name}" and all their responses?`)) {
                return;
            }

            respondents = respondents.filter(r => r.id !== respondentId);

            // If we removed the current respondent, switch to another or null
            if (currentRespondentId === respondentId) {
                currentRespondentId = respondents.length > 0 ? respondents[0].id : null;
            }

            saveData();
            renderRespondentList();
            refreshChartIfActive();
        }

        function renderRespondentList() {
            const dropdownPage1 = document.getElementById('respondentDropdownPage1');
            const dropdownPage2 = document.getElementById('respondentDropdown');
            const removeBtn = document.getElementById('removeRespondentBtn');

            // Update both dropdowns
            const dropdowns = [dropdownPage1, dropdownPage2];
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">-- Select a respondent --</option>';
                    respondents.forEach(respondent => {
                        const option = document.createElement('option');
                        option.value = respondent.id;
                        option.textContent = respondent.name;
                        if (respondent.id === currentRespondentId) {
                            option.selected = true;
                        }
                        dropdown.appendChild(option);
                    });
                }
            });

            // Show/hide remove button based on selection
            if (removeBtn) {
                removeBtn.style.display = currentRespondentId ? 'inline-block' : 'none';
            }
        }

        // Handle dropdown change on page 1
        function handleRespondentDropdownChangePage1() {
            const dropdown = document.getElementById('respondentDropdownPage1');
            const selectedRespondentId = dropdown.value;

            if (selectedRespondentId) {
                switchRespondent(selectedRespondentId);
            }
        }

        // Handle dropdown change on page 2
        function handleRespondentDropdownChange() {
            const dropdown = document.getElementById('respondentDropdown');
            const selectedRespondentId = dropdown.value;

            if (selectedRespondentId) {
                switchRespondent(selectedRespondentId);
            }
        }

        // Remove current respondent
        function removeCurrentRespondent() {
            if (currentRespondentId) {
                removeRespondent(currentRespondentId);
            }
        }

        // Add feature (Enter key support)
        document.addEventListener('DOMContentLoaded', () => {
            const featureInput = document.getElementById('featureInput');
            if (featureInput) {
                featureInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addFeature();
                    }
                });
            }

            const respondentInput = document.getElementById('respondentInput');
            if (respondentInput) {
                respondentInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addRespondent();
                    }
                });
            }
        });

        // Add a new feature
        function addFeature() {
            const input = document.getElementById('featureInput');
            const featureName = input.value.trim();

            if (featureName === '') {
                alert('Please enter a feature name');
                return;
            }

            if (features.includes(featureName)) {
                alert('This feature has already been added');
                return;
            }

            features.push(featureName);
            input.value = '';
            input.focus();

            saveData();
            renderFeaturesList();
            updateNextButton();
            refreshChartIfActive();
        }

        // Handle Excel file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Display selected file name
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            fileNameDisplay.textContent = file.name;

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Get the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Extract features from the first column
                    let addedCount = 0;
                    let duplicateCount = 0;
                    let emptyCount = 0;

                    jsonData.forEach((row, index) => {
                        if (row && row.length > 0) {
                            const featureName = String(row[0]).trim();

                            // Skip empty rows
                            if (featureName === '' || featureName === 'undefined') {
                                emptyCount++;
                                return;
                            }

                            // Check if feature already exists
                            if (features.includes(featureName)) {
                                duplicateCount++;
                                return;
                            }

                            // Add the feature
                            features.push(featureName);
                            addedCount++;
                        }
                    });

                    // Save and update UI
                    saveData();
                    renderFeaturesList();
                    updateNextButton();
                    refreshChartIfActive();

                    // Show summary message
                    let message = `Successfully imported ${addedCount} feature(s) from Excel file.`;
                    if (duplicateCount > 0) {
                        message += `\n${duplicateCount} duplicate(s) were skipped.`;
                    }
                    if (emptyCount > 0) {
                        message += `\n${emptyCount} empty row(s) were skipped.`;
                    }

                    alert(message);

                    // Clear the file input so the same file can be selected again if needed
                    event.target.value = '';

                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    alert('Error reading Excel file. Please make sure the file is a valid Excel format (.xlsx or .xls).');
                }
            };

            reader.onerror = function() {
                alert('Error reading file. Please try again.');
            };

            reader.readAsArrayBuffer(file);
        }

        // Remove a feature
        function removeFeature(index) {
            const feature = features[index];
            if (confirm(`Remove "${feature}"?`)) {
                features.splice(index, 1);

                // Remove feature from all respondents' priorities
                respondents.forEach(respondent => {
                    delete respondent.priorities[feature];
                });

                saveData();
                renderFeaturesList();
                updateNextButton();
                refreshChartIfActive();
            }
        }

        // Remove all features at once
        function removeAllFeatures() {
            if (features.length === 0) {
                return;
            }

            if (!confirm('Remove all features? This will clear priorities for every respondent.')) {
                return;
            }

            features = [];
            respondents.forEach(respondent => {
                respondent.priorities = {};
            });

            saveData();
            renderFeaturesList();
            updateNextButton();
            refreshChartIfActive();
        }

        // Render the features list on page 1
        function renderFeaturesList() {
            const listContainer = document.getElementById('featuresList');
            const removeAllButton = document.getElementById('removeAllFeaturesBtn');

            if (features.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No features added yet. Start by adding your first feature above.</p>
                    </div>
                `;

                if (removeAllButton) {
                    removeAllButton.style.display = 'none';
                }
                return;
            }

            listContainer.innerHTML = features.map((feature, index) => `
                <div class="feature-item">
                    <span>${feature}</span>
                    <button class="button-danger" onclick="removeFeature(${index})">Remove</button>
                </div>
            `).join('');

            if (removeAllButton) {
                removeAllButton.style.display = 'inline-block';
            }
        }

        // Update next button state
        function updateNextButton() {
            const nextButton = document.getElementById('nextButton');
            nextButton.disabled = features.length === 0;
        }

        // Navigate to prioritization page
        function goToPrioritization() {
            if (features.length === 0) {
                alert('Please add at least one feature first');
                return;
            }

            if (!currentRespondentId) {
                alert('Please add and select a respondent first');
                return;
            }

            document.getElementById('page1').classList.remove('active');
            document.getElementById('page2').classList.add('active');
            const chartPage = document.getElementById('page3');
            if (chartPage) {
                chartPage.classList.remove('active');
            }
            renderRespondentList(); // Update respondent name display
            renderPrioritizationTable();
        }

        // Navigate back to entry page
        function goBackToEntry() {
            document.getElementById('page2').classList.remove('active');
            document.getElementById('page1').classList.add('active');
            const chartPage = document.getElementById('page3');
            if (chartPage) {
                chartPage.classList.remove('active');
            }
            document.getElementById('summary').style.display = 'none';
        }

        function goToChartPage() {
            const prioritizationPage = document.getElementById('page2');
            const chartPage = document.getElementById('page3');

            if (prioritizationPage) {
                prioritizationPage.classList.remove('active');
            }

            if (chartPage) {
                chartPage.classList.add('active');
            }

            renderFeatureImportanceChart();
        }

        function goBackToPrioritization() {
            const prioritizationPage = document.getElementById('page2');
            const chartPage = document.getElementById('page3');

            if (chartPage) {
                chartPage.classList.remove('active');
            }

            if (prioritizationPage) {
                prioritizationPage.classList.add('active');
            }
        }

        // Render the prioritization table
        function renderPrioritizationTable() {
            const content = document.getElementById('prioritizationContent');
            const currentPriorities = getCurrentPriorities();

            let tableHTML = `
                <div class="table-responsive">
                    <table class="prioritization-table">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                ${priorityOptions.map(p => `<th class="priority-cell">${p.label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

            features.forEach((feature, index) => {
                tableHTML += `
                    <tr>
                        <td class="feature-name">${feature}</td>
                        ${priorityOptions.map(p => `
                            <td class="priority-cell">
                                <input
                                    type="radio"
                                    name="priority-${index}"
                                    value="${p.id}"
                                    ${currentPriorities[feature] === p.id ? 'checked' : ''}
                                    onchange="updatePriority('${feature.replace(/'/g, "\\'")}', '${p.id}')"
                                >
                            </td>
                        `).join('')}
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            content.innerHTML = tableHTML;
        }

        // Update priority for a feature
        function updatePriority(feature, priorityId) {
            const respondent = getCurrentRespondent();
            if (respondent) {
                respondent.priorities[feature] = priorityId;
                saveData();
                refreshChartIfActive();
            }
        }

        // Show summary
        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const currentPriorities = getCurrentPriorities();

            // Count features by priority for current respondent
            const counts = {
                must: 0,
                should: 0,
                nice: 0,
                not: 0,
                unassigned: 0
            };

            features.forEach(feature => {
                const priority = currentPriorities[feature];
                if (priority) {
                    counts[priority]++;
                } else {
                    counts.unassigned++;
                }
            });

            const currentRespondent = getCurrentRespondent();
            const respondentName = currentRespondent ? currentRespondent.name : 'Unknown';

            const summaryHTML = `
                <h3>Prioritization Summary for ${respondentName}</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">1. Must have</div>
                        <div class="summary-count">${counts.must}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">2. Should have</div>
                        <div class="summary-count">${counts.should}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">3. Nice to have</div>
                        <div class="summary-count">${counts.nice}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">4. Not needed</div>
                        <div class="summary-count">${counts.not}</div>
                    </div>
                    ${counts.unassigned > 0 ? `
                    <div class="summary-item">
                        <div class="summary-label">Unassigned</div>
                        <div class="summary-count" style="color: #dc3545;">${counts.unassigned}</div>
                    </div>
                    ` : ''}
                </div>
            `;

            summaryDiv.innerHTML = summaryHTML;
            summaryDiv.style.display = 'block';
            summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function renderFeatureImportanceChart() {
            const canvas = document.getElementById('featureImportanceChart');
            const wrapper = document.getElementById('chartWrapper');
            const emptyState = document.getElementById('chartEmptyState');

            if (!canvas || !wrapper || !emptyState) {
                return;
            }

            const aggregatedData = features.map(feature => {
                const counts = { must: 0, should: 0, nice: 0, not: 0 };

                respondents.forEach(respondent => {
                    const priority = respondent.priorities ? respondent.priorities[feature] : undefined;
                    if (priority && counts.hasOwnProperty(priority)) {
                        counts[priority]++;
                    }
                });

                return {
                    feature,
                    ...counts
                };
            });

            const totalAssigned = aggregatedData.reduce((sum, data) => sum + data.must + data.should + data.nice + data.not, 0);

            let emptyMessage = '';
            if (features.length === 0) {
                emptyMessage = 'Add features to see the chart.';
            } else if (respondents.length === 0) {
                emptyMessage = 'Add respondents and capture their input to populate this chart.';
            } else if (totalAssigned === 0) {
                emptyMessage = 'No prioritization data yet. Assign priorities to populate this chart.';
            }

            if (emptyMessage) {
                if (featureImportanceChart) {
                    featureImportanceChart.destroy();
                    featureImportanceChart = null;
                }
                canvas.style.display = 'none';
                emptyState.textContent = emptyMessage;
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            canvas.style.display = 'block';

            aggregatedData.sort((a, b) => {
                if (b.must !== a.must) return b.must - a.must;
                if (b.should !== a.should) return b.should - a.should;
                if (b.nice !== a.nice) return b.nice - a.nice;
                return b.not - a.not;
            });

            const labels = aggregatedData.map(item => item.feature);

            const datasetConfigs = [
                { key: 'must', color: '#6C63FF' },
                { key: 'should', color: '#4CAF50' },
                { key: 'nice', color: '#FFC107' },
                { key: 'not', color: '#FF7043' }
            ];

            const datasets = datasetConfigs.map(config => {
                const priorityOption = priorityOptions.find(option => option.id === config.key);
                return {
                    label: priorityOption ? priorityOption.label : config.key,
                    data: aggregatedData.map(item => item[config.key]),
                    backgroundColor: config.color,
                    borderWidth: 1,
                    borderColor: '#ffffff',
                    borderRadius: 6,
                    maxBarThickness: 48
                };
            });

            const chartHeight = Math.max(aggregatedData.length * 60, 320);
            wrapper.style.height = `${chartHeight}px`;

            if (featureImportanceChart) {
                featureImportanceChart.destroy();
            }

            featureImportanceChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: context => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.x;
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of responses'
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                }
            });
        }

        function refreshChartIfActive() {
            const chartPage = document.getElementById('page3');
            if (chartPage && chartPage.classList.contains('active')) {
                renderFeatureImportanceChart();
            }
        }

        // Export data to Excel with respondents as rows and features as columns
        function exportToExcel() {
            if (features.length === 0) {
                alert('No features to export');
                return;
            }

            if (respondents.length === 0) {
                alert('No respondents to export');
                return;
            }

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();

            // Prepare data: Respondents as rows, Features as columns
            const data = [];

            // Header row: Respondent | Feature1 | Feature2 | Feature3 | ...
            const headerRow = ['Respondent', ...features];
            data.push(headerRow);

            // Data rows: Each respondent with their priorities for all features
            respondents.forEach(respondent => {
                const row = [respondent.name];

                features.forEach(feature => {
                    const priorityId = respondent.priorities[feature];
                    let priorityLabel = 'Not assigned';

                    if (priorityId) {
                        const priorityOption = priorityOptions.find(p => p.id === priorityId);
                        if (priorityOption) {
                            priorityLabel = priorityOption.label;
                        }
                    }

                    row.push(priorityLabel);
                });

                data.push(row);
            });

            // Create worksheet from data
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            const colWidths = [
                { wch: 25 }, // Respondent column
                ...features.map(() => ({ wch: 25 })) // Feature columns
            ];
            ws['!cols'] = colWidths;

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Prioritization Results');

            // Generate filename with current date
            const date = new Date();
            const filename = `feature-prioritization-${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}.xlsx`;

            // Write and download file
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>
