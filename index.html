<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Feature Prioritization Tool for customer interviews and product development">
    <title>Feature Prioritization Tool</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* Color Palette */
            --color-primary: #125cff;
            --color-primary-hover: rgba(18, 92, 255, 0.15);
            --color-primary-active: rgba(18, 92, 255, 0.28);
            --color-accent: #CFFF00;
            --color-accent-hover: #b8e600;
            --color-accent-light: rgba(207, 255, 0, 0.12);
            --color-accent-light-hover: rgba(207, 255, 0, 0.25);
            --color-danger: #E799A3;
            --color-danger-hover: #d6828d;
            --color-danger-text: #dc3545;
            --color-success: #4CAF50;
            --color-warning: #FFC107;
            --color-info: #7c4dff;
            --color-info-hover: #6535ff;
            
            /* Neutral Colors */
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f5f4f3;
            --color-bg-tertiary: #f8f9fa;
            --color-text-primary: #333;
            --color-text-secondary: #666;
            --color-text-tertiary: #999;
            --color-border: #e0e0e0;
            --color-border-light: #e5e7eb;
            
            /* Background */
            --color-bg-gradient-start: #C8C4BF;
            --color-bg-gradient-end: #a8a49f;
            
            /* Chart Colors */
            --chart-color-must: #6C63FF;
            --chart-color-should: #4CAF50;
            --chart-color-nice: #FFC107;
            --chart-color-not: #FF7043;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 20px;
            --spacing-xl: 30px;
            --spacing-xxl: 40px;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 10px;
            --radius-xl: 12px;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 50px rgba(0, 0, 0, 0.25);
            
            /* Transitions */
            --transition-fast: 0.2s ease-in-out;
            --transition-normal: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--color-bg-gradient-start) 0%, var(--color-bg-gradient-end) 100%);
            min-height: 100vh;
            padding: var(--spacing-lg);
            color: var(--color-text-primary);
        }

        body.locked {
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        .login-screen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .login-card {
            background: var(--color-bg-primary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xxl);
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-xl);
            text-align: center;
        }

        .login-card img {
            height: 48px;
            width: auto;
            margin-bottom: var(--spacing-lg);
        }

        .login-card h2 {
            color: var(--color-text-primary);
            margin-bottom: 10px;
            font-size: 1.6em;
        }

        .login-card p {
            color: var(--color-text-secondary);
            margin-bottom: 25px;
        }

        .login-card .input-group {
            flex-direction: column;
            align-items: stretch;
        }

        .login-card input[type="text"],
        .login-card input[type="password"] {
            margin-bottom: 15px;
        }

        .login-error {
            color: var(--color-danger-text);
            margin-top: 10px;
            min-height: 20px;
            font-size: 0.95em;
            font-weight: 500;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        label:not(.sr-only) {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text-primary);
            font-weight: 500;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: var(--color-bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xxl);
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 3px solid var(--color-primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            color: var(--color-bg-primary);
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition: all var(--transition-normal);
            max-width: 300px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification-success {
            background: var(--color-success);
        }
        
        .notification-warning {
            background: var(--color-warning);
        }
        
        .notification-error {
            background: var(--color-danger-text);
        }
        
        .notification-info {
            background: var(--color-primary);
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 30px;
        }

        .app-logo {
            height: 48px;
            width: auto;
        }

        .app-layout {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .app-navigation {
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #ffffff;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            min-width: 220px;
        }

        .app-main {
            flex: 1;
        }

        .nav-button {
            background: rgba(18, 92, 255, 0.08);
            color: var(--color-primary);
            border: none;
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-md);
            font-size: 1em;
            font-weight: 600;
            letter-spacing: 0.01em;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            width: 100%;
        }

        .nav-button:hover:not(:disabled) {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-button.active {
            background: var(--color-primary);
            color: #ffffff;
            box-shadow: 0 12px 28px var(--color-primary-active);
        }

        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-section-title {
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6b7280;
            padding: 8px 12px 4px;
        }

        .nav-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 8px 0;
        }

        .nav-action-button {
            background: var(--color-accent-light);
            color: #5a6600;
            border: none;
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-md);
            font-size: 0.95em;
            font-weight: 600;
            letter-spacing: 0.01em;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            width: 100%;
        }

        .nav-action-button:hover:not(:disabled) {
            background: var(--color-accent-light-hover);
            transform: translateY(-1px);
        }
        
        .nav-action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-action-button:active:not(:disabled) {
            transform: translateY(0);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1em;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Page 1 - Feature Entry */
        .feature-input-section {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input[type="text"],
        input[type="password"] {
            flex: 1;
            padding: var(--spacing-md) 15px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 1em;
            transition: border-color var(--transition-normal);
            background: var(--color-bg-primary);
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(207, 255, 0, 0.1);
        }
        
        input[type="text"]:invalid:not(:focus):not(:placeholder-shown),
        input[type="password"]:invalid:not(:focus):not(:placeholder-shown) {
            border-color: var(--color-danger-text);
        }

        select {
            padding: var(--spacing-md) 15px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 1em;
            transition: border-color var(--transition-normal);
            background: var(--color-bg-primary);
            cursor: pointer;
            min-width: 250px;
        }

        select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(207, 255, 0, 0.1);
        }

        select:hover:not(:disabled) {
            border-color: var(--color-accent);
        }
        
        select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .respondent-dropdown-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .respondent-dropdown-label {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }

        button {
            padding: var(--spacing-md) 24px;
            background: var(--color-accent);
            color: var(--color-text-primary);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1em;
            cursor: pointer;
            transition: all var(--transition-normal);
            font-weight: 600;
            position: relative;
        }

        button:hover:not(:disabled) {
            background: var(--color-accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background: var(--color-border);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        button:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .button-secondary {
            background: var(--color-bg-gradient-start);
            color: var(--color-text-primary);
        }

        .button-secondary:hover:not(:disabled) {
            background: #b0ada8;
        }

        .button-success {
            background: var(--color-accent);
            color: var(--color-text-primary);
        }

        .button-success:hover:not(:disabled) {
            background: var(--color-accent-hover);
        }

        .button-danger {
            background: var(--color-danger);
            padding: 6px 12px;
            font-size: 0.9em;
            color: var(--color-text-primary);
        }

        .button-danger:hover:not(:disabled) {
            background: var(--color-danger-hover);
        }

        .button-info {
            background: var(--color-accent);
            color: var(--color-text-primary);
        }

        .button-info:hover:not(:disabled) {
            background: var(--color-accent-hover);
        }

        .button-chart {
            background: var(--color-info);
            color: #fff;
        }

        .button-chart:hover:not(:disabled) {
            background: var(--color-info-hover);
        }

        .file-upload-section {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-lg);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            border: 2px dashed var(--color-accent);
            transition: all var(--transition-normal);
        }
        
        .file-upload-section:hover {
            border-color: var(--color-accent-hover);
            background: rgba(207, 255, 0, 0.05);
        }
        
        .file-upload-section.dragover {
            border-color: var(--color-primary);
            background: rgba(18, 92, 255, 0.05);
        }

        .file-upload-label {
            display: block;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }

        .file-upload-description {
            display: block;
            margin-bottom: 15px;
            color: #666;
            font-size: 0.9em;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-button {
            display: inline-block;
            padding: 10px 20px;
            background: #CFFF00;
            color: #333;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
        }

        .file-upload-button:hover {
            background: #b8e600;
        }

        .file-name-display {
            margin-left: 15px;
            color: #666;
            font-style: italic;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            color: #999;
            font-weight: 600;
        }

        .respondent-section {
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            border: 2px solid var(--color-accent);
        }

        .respondent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .respondent-label {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .respondent-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .respondent-input {
            flex: 1;
            min-width: 200px;
        }

        .respondent-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .respondent-tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid #CFFF00;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .respondent-tab:hover {
            background: #ffffcc;
        }

        .respondent-tab.active {
            background: #CFFF00;
            color: #333;
            font-weight: 600;
        }

        .respondent-tab-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            margin-left: 5px;
            line-height: 1;
        }

        .respondent-tab.active .respondent-tab-remove {
            color: white;
        }

        .respondent-tab-remove:hover {
            opacity: 0.7;
        }

        .respondent-info {
            background: #f5f4f3;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #CFFF00;
        }

        .respondent-info-text {
            color: #333;
            font-weight: 600;
        }

        .button-warning {
            background: #CFFF00;
            color: #333;
        }

        .button-warning:hover {
            background: #b8e600;
        }

        .features-list {
            margin-top: 20px;
        }

        .features-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .feature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) 15px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            border-left: 4px solid var(--color-accent);
            gap: var(--spacing-md);
            flex-wrap: wrap;
            transition: all var(--transition-fast);
        }
        
        .feature-item:hover {
            background: rgba(207, 255, 0, 0.1);
            transform: translateX(4px);
        }

        .feature-item span {
            color: #333;
            font-size: 1em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* Page 2 - Prioritization */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }

        .prioritization-table {
            width: 100%;
            min-width: 520px;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
        }

        .prioritization-table thead {
            background: var(--color-accent);
            color: var(--color-text-primary);
        }

        .prioritization-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
        }

        .prioritization-table th:first-child {
            border-top-left-radius: 8px;
        }

        .prioritization-table th:last-child {
            border-top-right-radius: 8px;
        }

        .prioritization-table td {
            padding: 15px;
            border-bottom: 1px solid var(--color-border);
        }

        .prioritization-table tbody tr {
            background: var(--color-bg-primary);
            transition: background var(--transition-fast);
        }

        .prioritization-table tbody tr:hover {
            background: var(--color-bg-tertiary);
        }
        
        .prioritization-table tbody tr:focus-within {
            background: rgba(207, 255, 0, 0.1);
        }

        .prioritization-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 8px;
        }

        .prioritization-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 8px;
        }

        .feature-name {
            font-weight: 500;
            color: #333;
        }

        input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-accent);
            transition: transform var(--transition-fast);
        }
        
        input[type="radio"]:hover {
            transform: scale(1.1);
        }
        
        input[type="radio"]:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
            border-radius: 50%;
        }
        
        .radio-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .priority-cell {
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .summary {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-accent);
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chart-page-intro {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.6;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            min-height: 320px;
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-xl);
            padding: var(--spacing-lg);
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-empty-state {
            text-align: center;
            color: #777;
            padding: 60px 20px;
        }

        .summary h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .summary-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .summary-count {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .container {
                padding: 25px;
            }

            .app-layout {
                flex-direction: column;
            }

            .app-navigation {
                flex-direction: column;
                padding: 10px 14px;
                margin-bottom: 20px;
                min-width: 0;
            }

            .nav-section {
                flex-direction: row;
                gap: 6px;
            }

            .nav-section-title {
                display: none;
            }

            .nav-divider {
                display: none;
            }

            .nav-button {
                flex: 1;
                width: auto;
                font-size: 0.85em;
                padding: 10px 8px;
            }

            .nav-action-button {
                flex: 1;
                width: auto;
                font-size: 0.85em;
                padding: 10px 8px;
            }

            h1 {
                font-size: 1.6em;
            }

            .respondent-dropdown-container,
            .respondent-input-group,
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .respondent-dropdown-container label,
            .respondent-dropdown-container select,
            .respondent-dropdown-container button,
            .respondent-input-group input,
            .respondent-input-group button,
            .input-group input,
            .input-group button,
            .file-upload-button,
            .button-group button {
                width: 100%;
            }

            select,
            input[type="text"] {
                min-width: 0;
            }

            .respondent-list {
                flex-direction: column;
            }

            .feature-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .feature-item button {
                width: 100%;
            }

            .button-group {
                flex-direction: column;
            }

            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }

            .prioritization-table {
                font-size: 0.9em;
            }

            .prioritization-table th,
            .prioritization-table td {
                padding: 10px 6px;
            }

            input[type="radio"] {
                width: 16px;
                height: 16px;
            }

            .file-name-display {
                margin-left: 0;
                display: block;
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            .app-header {
                justify-content: flex-start;
                margin-bottom: 25px;
            }

            .app-logo {
                height: 40px;
            }

            h1 {
                font-size: 1.4em;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            button {
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body class="locked">
    <div id="login-screen" class="login-screen" role="dialog" aria-labelledby="login-title" aria-modal="true">
        <div class="login-card">
            <img src="northlane-logo.svg" alt="Northlane logo" width="auto" height="48">
            <h2 id="login-title">Secure Access</h2>
            <p>Please enter your Northlane credentials to continue.</p>
            <form id="login-form" aria-label="Login form">
                <div class="input-group">
                    <label for="login-id" class="sr-only">User ID</label>
                    <input 
                        type="text" 
                        id="login-id" 
                        name="login-id"
                        placeholder="Enter ID" 
                        autocomplete="username" 
                        required
                        aria-required="true"
                        aria-describedby="login-error"
                    >
                    <label for="login-password" class="sr-only">Password</label>
                    <input 
                        type="password" 
                        id="login-password" 
                        name="login-password"
                        placeholder="Enter password" 
                        autocomplete="current-password"
                        required
                        aria-required="true"
                        aria-describedby="login-error"
                    >
                </div>
                <button type="submit">Unlock Application</button>
            </form>
            <div id="login-error" class="login-error" role="alert" aria-live="polite" aria-atomic="true"></div>
        </div>
    </div>
    <div id="app-content" class="container hidden">
        <div class="app-header">
            <img src="northlane-logo.svg" alt="Northlane logo" class="app-logo">
        </div>
        <div class="app-layout">
            <div class="app-navigation">
                <div class="nav-section">
                    <div class="nav-section-title">Pages</div>
                    <button type="button" class="nav-button active" data-target="page1" onclick="navigateToPage('page1')">
                        <span>1.</span>
                        <span>Feature Entry</span>
                    </button>
                    <button type="button" class="nav-button" data-target="page2" onclick="navigateToPage('page2')">
                        <span>2.</span>
                        <span>Prioritize Features</span>
                    </button>
                    <button type="button" class="nav-button" data-target="page3" onclick="navigateToPage('page3')">
                        <span>3.</span>
                        <span>Insights &amp; Chart</span>
                    </button>
                </div>
                <div class="nav-divider"></div>
                <div class="nav-section">
                    <div class="nav-section-title">Actions</div>
                    <button type="button" class="nav-action-button" onclick="exportToExcel()">
                        <span>Export to Excel</span>
                    </button>
                    <button type="button" class="nav-action-button" onclick="showSummary()">
                        <span>View Summary</span>
                    </button>
                </div>
            </div>
            <div class="app-main">
                <!-- Page 1: Feature Entry -->
                <div id="page1" class="page active" role="region" aria-label="Feature Entry">
            <h1>Feature Prioritization Tool</h1>
            <p class="subtitle">Enter the features you want to discuss during customer interviews</p>

            <section class="respondent-section" aria-labelledby="respondent-management-heading">
                <div class="respondent-header">
                    <h2 id="respondent-management-heading" class="respondent-label">Respondent Management</h2>
                </div>
                <div class="respondent-input-group">
                    <label for="respondentInput" class="sr-only">Respondent Name</label>
                    <input
                        type="text"
                        id="respondentInput"
                        class="respondent-input"
                        placeholder="Enter respondent name..."
                        autocomplete="name"
                        aria-label="Enter respondent name"
                        aria-describedby="respondent-help"
                    >
                    <button onclick="addRespondent()" class="button-warning" aria-label="Add new respondent">Add New Respondent</button>
                    <span id="respondent-help" class="sr-only">Enter a name for the new respondent</span>
                </div>
                <div class="respondent-dropdown-container" style="margin-top: 15px;">
                    <label for="respondentDropdownPage1" class="respondent-dropdown-label">Current Respondent:</label>
                    <select 
                        id="respondentDropdownPage1" 
                        onchange="handleRespondentDropdownChangePage1()"
                        aria-label="Select current respondent"
                    >
                        <option value="">-- Select a respondent --</option>
                    </select>
                    <button 
                        onclick="removeCurrentRespondent()" 
                        class="button-danger" 
                        id="removeRespondentBtn" 
                        style="display: none;"
                        aria-label="Remove current respondent"
                    >Remove</button>
                </div>
            </section>

            <section class="file-upload-section" aria-labelledby="file-upload-label" id="fileUploadSection">
                <label id="file-upload-label" class="file-upload-label">Upload Excel File</label>
                <span id="file-upload-description" class="file-upload-description">Upload an Excel file (.xlsx, .xls) with features listed in the first column. You can drag and drop a file here.</span>
                <input 
                    type="file" 
                    id="excelFileInput" 
                    accept=".xlsx,.xls" 
                    onchange="handleFileUpload(event)"
                    aria-label="Choose Excel file to upload"
                    aria-describedby="file-upload-description"
                >
                <label for="excelFileInput" class="file-upload-button" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();document.getElementById('excelFileInput').click();}">Choose Excel File</label>
                <span id="fileNameDisplay" class="file-name-display" aria-live="polite"></span>
            </section>

            <div class="divider">OR</div>

            <section class="feature-input-section" aria-labelledby="feature-input-heading">
                <h2 id="feature-input-heading" class="sr-only">Add Feature</h2>
                <div class="input-group">
                    <label for="featureInput" class="sr-only">Feature Name</label>
                    <input
                        type="text"
                        id="featureInput"
                        placeholder="Enter a feature (e.g., 'User authentication', 'Export to PDF')..."
                        autocomplete="off"
                        aria-label="Enter a feature name"
                        aria-describedby="feature-help"
                    >
                    <button onclick="addFeature()" aria-label="Add feature to list">Add Feature</button>
                    <span id="feature-help" class="sr-only">Press Enter or click Add Feature to add the feature to your list</span>
                </div>
            </section>

            <section class="features-list" aria-labelledby="features-heading">
                <div class="features-list-header">
                    <h2 id="features-heading" style="color: #333;">Features to Prioritize</h2>
                    <button
                        id="removeAllFeaturesBtn"
                        class="button-danger"
                        onclick="removeAllFeatures()"
                        style="display: none;"
                        aria-label="Remove all features"
                    >
                        Remove All Features
                    </button>
                </div>
                <div id="featuresList" role="list" aria-label="List of features">
                    <div class="empty-state" role="listitem">
                        <div class="empty-state-icon" aria-hidden="true">📝</div>
                        <p>No features added yet. Start by adding your first feature above.</p>
                    </div>
                </div>
            </section>

            <div class="button-group">
                <button
                    onclick="goToPrioritization()"
                    id="nextButton"
                    class="button-success"
                    disabled
                >
                    Next: Prioritize Features →
                </button>
            </div>
                </div>

                <!-- Page 2: Prioritization -->
                <div id="page2" class="page" role="region" aria-label="Feature Prioritization">
            <h1>Prioritize Features</h1>
            <p class="subtitle">Select the priority level for each feature</p>

            <section class="respondent-section" aria-labelledby="respondent-select-heading">
                <h2 id="respondent-select-heading" class="sr-only">Select Respondent</h2>
                <div class="respondent-dropdown-container">
                    <label for="respondentDropdown" class="respondent-dropdown-label">Select Respondent:</label>
                    <select 
                        id="respondentDropdown" 
                        onchange="handleRespondentDropdownChange()"
                        aria-label="Select respondent for prioritization"
                    >
                        <option value="">-- Select a respondent --</option>
                    </select>
                </div>
            </section>

            <div id="prioritizationContent" role="region" aria-label="Prioritization table">
                <!-- Table will be generated by JavaScript -->
            </div>

            <div class="button-group">
                <button onclick="goBackToEntry()" class="button-secondary">← Back to Features</button>
                <button onclick="exportToExcel()" class="button-info">Export to Excel</button>
                <button onclick="goToChartPage()" class="button-chart">Feature Importance Chart</button>
                <button onclick="showSummary()" class="button-success">View Summary</button>
            </div>

            <div id="summary" class="summary" style="display: none;">
                <!-- Summary will be generated by JavaScript -->
            </div>
                </div>

                <!-- Page 3: Feature Importance Chart -->
                <div id="page3" class="page" role="region" aria-label="Feature Importance Chart">
            <h1>Feature Importance Overview</h1>
            <p class="chart-page-intro">
                This stacked bar chart aggregates responses from every respondent. Each bar shows how often a feature was
                classified into each priority category, helping you quickly spot the most critical capabilities.
            </p>

            <div class="chart-wrapper" id="chartWrapper" role="img" aria-label="Feature importance stacked bar chart">
                <canvas id="featureImportanceChart" aria-label="Chart displaying feature importance across all respondents"></canvas>
                <div id="chartEmptyState" class="chart-empty-state" style="display: none;" role="status" aria-live="polite">
                    No prioritization data yet. Assign priorities to features to populate this chart.
                </div>
            </div>

            <div class="button-group">
                <button onclick="goBackToPrioritization()" class="button-secondary">← Back to Prioritization</button>
            </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const VALID_ID = 'NorthlaneApp';
        const VALID_PASSWORD = 'TestNorthFeatures';

        let appUnlocked = false;

        function handleLogin(event) {
            if (event) {
                event.preventDefault();
            }

            const idInput = document.getElementById('login-id');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');

            const enteredId = idInput ? idInput.value.trim() : '';
            const enteredPassword = passwordInput ? passwordInput.value : '';

            if (enteredId === VALID_ID && enteredPassword === VALID_PASSWORD) {
                sessionStorage.setItem('northlaneAppUnlocked', 'true');
                unlockApplication();
                if (errorDiv) {
                    errorDiv.textContent = '';
                }
            } else {
                if (errorDiv) {
                    errorDiv.textContent = 'Invalid ID or password. Please try again.';
                }
                if (passwordInput) {
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            }
        }

        function unlockApplication() {
            if (appUnlocked) {
                return;
            }

            appUnlocked = true;

            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');

            if (loginScreen) {
                loginScreen.classList.add('hidden');
            }

            if (appContent) {
                appContent.classList.remove('hidden');
            }

            document.body.classList.remove('locked');

            initializeAppData();
        }

        function initializeAppData() {
            loadData();
            renderRespondentList();
            renderFeaturesList();
            updateNextButton();
            setActivePage('page1');
        }

        window.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const storedUnlock = sessionStorage.getItem('northlaneAppUnlocked');
            if (storedUnlock === 'true') {
                unlockApplication();
            } else {
                const idInput = document.getElementById('login-id');
                if (idInput) {
                    idInput.focus();
                }
            }
        });

        // Data storage - Multi-respondent structure
        let features = [];
        let respondents = []; // Array of {id, name, priorities: {}}
        let currentRespondentId = null;
        let featureImportanceChart = null;
        const pageIds = ['page1', 'page2', 'page3'];

        // Priority options (in order)
        const priorityOptions = [
            { id: 'must', label: '1. Must have' },
            { id: 'should', label: '2. Should have' },
            { id: 'nice', label: '3. Nice to have' },
            { id: 'not', label: '4. Not needed' }
        ];

        // Utility: Sanitize text to prevent XSS
        function sanitizeText(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Utility: Escape HTML entities
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Utility: Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Save data to localStorage with error handling
        function saveData() {
            try {
                localStorage.setItem('features', JSON.stringify(features));
                localStorage.setItem('respondents', JSON.stringify(respondents));
                localStorage.setItem('currentRespondentId', currentRespondentId || '');
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showNotification('Error saving data. Your changes may not persist.', 'error');
            }
        }

        // Load data from localStorage with error handling
        function loadData() {
            try {
                const savedFeatures = localStorage.getItem('features');
                const savedRespondents = localStorage.getItem('respondents');
                const savedCurrentRespondentId = localStorage.getItem('currentRespondentId');

                if (savedFeatures) {
                    const parsed = JSON.parse(savedFeatures);
                    if (Array.isArray(parsed)) {
                        features = parsed;
                    }
                }
                if (savedRespondents) {
                    const parsed = JSON.parse(savedRespondents);
                    if (Array.isArray(parsed)) {
                        respondents = parsed;
                    }
                }
                if (savedCurrentRespondentId) {
                    currentRespondentId = savedCurrentRespondentId;
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                // Reset to defaults on error
                features = [];
                respondents = [];
                currentRespondentId = null;
            }
        }

        // Get current respondent object
        function getCurrentRespondent() {
            return respondents.find(r => r.id === currentRespondentId);
        }

        // Get current priorities for active respondent
        function getCurrentPriorities() {
            const respondent = getCurrentRespondent();
            return respondent ? respondent.priorities : {};
        }

        // Respondent Management Functions with validation
        function addRespondent() {
            const input = document.getElementById('respondentInput');
            if (!input) {
                console.error('Respondent input not found');
                return;
            }
            
            let respondentName = input.value.trim();

            // Validate input
            if (respondentName === '') {
                showNotification('Please enter a respondent name', 'warning');
                input.focus();
                return;
            }

            // Limit respondent name length
            if (respondentName.length > 100) {
                showNotification('Respondent name is too long (max 100 characters)', 'warning');
                input.select();
                return;
            }

            // Sanitize name (remove HTML tags)
            respondentName = respondentName.replace(/<[^>]*>/g, '').trim();

            if (respondentName === '') {
                showNotification('Invalid respondent name', 'warning');
                input.focus();
                return;
            }

            // Check if respondent name already exists (case-insensitive)
            if (respondents.some(r => r.name.toLowerCase() === respondentName.toLowerCase())) {
                showNotification('A respondent with this name already exists', 'warning');
                input.select();
                return;
            }

            // Create new respondent with unique ID
            const timestamp = Date.now();
            const randomSuffix = Math.random().toString(36).substr(2, 5);
            const newRespondent = {
                id: `resp_${timestamp}_${randomSuffix}`,
                name: respondentName,
                priorities: {}
            };

            respondents.push(newRespondent);
            currentRespondentId = newRespondent.id;

            input.value = '';
            saveData();
            renderRespondentList();
            refreshChartIfActive();
            showNotification(`Respondent "${respondentName}" added successfully`, 'success');
        }

        function switchRespondent(respondentId) {
            currentRespondentId = respondentId;
            saveData();
            renderRespondentList();

            // Refresh the prioritization table if on page 2
            const page2 = document.getElementById('page2');
            if (page2 && page2.classList.contains('active')) {
                renderPrioritizationTable();
                // Hide summary when switching respondents
                const summaryDiv = document.getElementById('summary');
                if (summaryDiv) {
                    summaryDiv.style.display = 'none';
                }
            }
        }

        function removeRespondent(respondentId) {
            const respondent = respondents.find(r => r.id === respondentId);
            if (!respondent) {
                console.error('Respondent not found');
                return;
            }

            if (!confirm(`Remove respondent "${respondent.name}" and all their responses?`)) {
                return;
            }

            respondents = respondents.filter(r => r.id !== respondentId);

            // If we removed the current respondent, switch to another or null
            if (currentRespondentId === respondentId) {
                currentRespondentId = respondents.length > 0 ? respondents[0].id : null;
            }

            saveData();
            renderRespondentList();
            refreshChartIfActive();
            showNotification(`Respondent "${respondent.name}" removed`, 'info');
        }

        function renderRespondentList() {
            const dropdownPage1 = document.getElementById('respondentDropdownPage1');
            const dropdownPage2 = document.getElementById('respondentDropdown');
            const removeBtn = document.getElementById('removeRespondentBtn');

            // Update both dropdowns
            const dropdowns = [dropdownPage1, dropdownPage2];
            dropdowns.forEach(dropdown => {
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">-- Select a respondent --</option>';
                    respondents.forEach(respondent => {
                        const option = document.createElement('option');
                        option.value = respondent.id;
                        option.textContent = respondent.name;
                        if (respondent.id === currentRespondentId) {
                            option.selected = true;
                        }
                        dropdown.appendChild(option);
                    });
                }
            });

            // Show/hide remove button based on selection
            if (removeBtn) {
                removeBtn.style.display = currentRespondentId ? 'inline-block' : 'none';
            }
        }

        // Handle dropdown change on page 1
        function handleRespondentDropdownChangePage1() {
            const dropdown = document.getElementById('respondentDropdownPage1');
            const selectedRespondentId = dropdown.value;

            if (selectedRespondentId) {
                switchRespondent(selectedRespondentId);
            }
        }

        // Handle dropdown change on page 2
        function handleRespondentDropdownChange() {
            const dropdown = document.getElementById('respondentDropdown');
            const selectedRespondentId = dropdown.value;

            if (selectedRespondentId) {
                switchRespondent(selectedRespondentId);
            }
        }

        // Remove current respondent
        function removeCurrentRespondent() {
            if (currentRespondentId) {
                removeRespondent(currentRespondentId);
            }
        }

        // Add feature (Enter key support) and drag-and-drop
        document.addEventListener('DOMContentLoaded', () => {
            const featureInput = document.getElementById('featureInput');
            if (featureInput) {
                featureInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addFeature();
                    }
                });
            }

            const respondentInput = document.getElementById('respondentInput');
            if (respondentInput) {
                respondentInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addRespondent();
                    }
                });
            }
            
            // Setup drag and drop for file upload
            const fileUploadSection = document.getElementById('fileUploadSection');
            const fileInput = document.getElementById('excelFileInput');
            
            if (fileUploadSection && fileInput) {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileUploadSection.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                // Highlight drop area when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    fileUploadSection.addEventListener(eventName, () => {
                        fileUploadSection.classList.add('dragover');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    fileUploadSection.addEventListener(eventName, () => {
                        fileUploadSection.classList.remove('dragover');
                    }, false);
                });
                
                // Handle dropped files
                fileUploadSection.addEventListener('drop', (e) => {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        fileInput.files = files;
                        const event = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(event);
                    }
                }, false);
            }
        });

        // Add a new feature with validation
        function addFeature() {
            const input = document.getElementById('featureInput');
            if (!input) {
                console.error('Feature input not found');
                return;
            }
            
            let featureName = input.value.trim();

            // Validate input
            if (featureName === '') {
                showNotification('Please enter a feature name', 'warning');
                input.focus();
                return;
            }

            // Limit feature name length
            if (featureName.length > 200) {
                showNotification('Feature name is too long (max 200 characters)', 'warning');
                input.select();
                return;
            }

            // Check for duplicate (case-insensitive)
            if (features.some(f => f.toLowerCase() === featureName.toLowerCase())) {
                showNotification('This feature has already been added', 'warning');
                input.select();
                return;
            }

            // Sanitize feature name (remove any HTML tags, keep only text)
            featureName = featureName.replace(/<[^>]*>/g, '').trim();

            if (featureName === '') {
                showNotification('Invalid feature name', 'warning');
                input.focus();
                return;
            }

            features.push(featureName);
            input.value = '';
            input.focus();

            saveData();
            renderFeaturesList();
            updateNextButton();
            refreshChartIfActive();
            showNotification(`Feature "${featureName}" added successfully`, 'success');
        }
        
        // Simple notification system
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', 'polite');
            
            document.body.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 10);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Handle Excel file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Validate file type
            const validTypes = ['.xlsx', '.xls'];
            const fileName = file.name.toLowerCase();
            const isValidType = validTypes.some(type => fileName.endsWith(type));
            
            if (!isValidType) {
                alert('Invalid file type. Please upload an Excel file (.xlsx or .xls).');
                event.target.value = '';
                return;
            }

            // Display selected file name
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            if (fileNameDisplay) {
                fileNameDisplay.textContent = `Selected: ${file.name}`;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Get the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Extract features from the first column
                    let addedCount = 0;
                    let duplicateCount = 0;
                    let emptyCount = 0;

                    jsonData.forEach((row, index) => {
                        if (row && row.length > 0) {
                            const featureName = String(row[0]).trim();

                            // Skip empty rows
                            if (featureName === '' || featureName === 'undefined') {
                                emptyCount++;
                                return;
                            }

                            // Check if feature already exists
                            if (features.includes(featureName)) {
                                duplicateCount++;
                                return;
                            }

                            // Add the feature
                            features.push(featureName);
                            addedCount++;
                        }
                    });

                    // Save and update UI
                    saveData();
                    renderFeaturesList();
                    updateNextButton();
                    refreshChartIfActive();

                    // Show summary message via notification
                    let message = `Successfully imported ${addedCount} feature(s) from Excel file.`;
                    if (duplicateCount > 0) {
                        message += ` ${duplicateCount} duplicate(s) skipped.`;
                    }
                    if (emptyCount > 0) {
                        message += ` ${emptyCount} empty row(s) skipped.`;
                    }

                    showNotification(message, addedCount > 0 ? 'success' : 'info');

                    // Clear the file input so the same file can be selected again if needed
                    event.target.value = '';

                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    showNotification('Error reading Excel file. Please make sure the file is a valid Excel format (.xlsx or .xls).', 'error');
                    event.target.value = '';
                }
            };

            reader.onerror = function() {
                showNotification('Error reading file. Please try again.', 'error');
                event.target.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        // Remove a feature with validation
        function removeFeature(index) {
            if (index < 0 || index >= features.length) {
                console.error('Invalid feature index');
                return;
            }
            
            const feature = features[index];
            if (!feature) {
                console.error('Feature not found at index', index);
                return;
            }
            
            if (confirm(`Remove "${escapeHtml(feature)}"?`)) {
                features.splice(index, 1);

                // Remove feature from all respondents' priorities
                respondents.forEach(respondent => {
                    if (respondent.priorities) {
                        delete respondent.priorities[feature];
                    }
                });

                saveData();
                renderFeaturesList();
                updateNextButton();
                refreshChartIfActive();
                showNotification(`Feature "${feature}" removed`, 'info');
            }
        }

        // Remove all features at once
        function removeAllFeatures() {
            if (features.length === 0) {
                return;
            }

            if (!confirm('Remove all features? This will clear priorities for every respondent.')) {
                return;
            }

            features = [];
            respondents.forEach(respondent => {
                respondent.priorities = {};
            });

            saveData();
            renderFeaturesList();
            updateNextButton();
            refreshChartIfActive();
        }

        // Render the features list on page 1 with XSS protection
        function renderFeaturesList() {
            const listContainer = document.getElementById('featuresList');
            const removeAllButton = document.getElementById('removeAllFeaturesBtn');
            
            if (!listContainer) {
                console.error('Features list container not found');
                return;
            }

            if (features.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state" role="listitem">
                        <div class="empty-state-icon" aria-hidden="true">📝</div>
                        <p>No features added yet. Start by adding your first feature above.</p>
                    </div>
                `;

                if (removeAllButton) {
                    removeAllButton.style.display = 'none';
                }
                return;
            }

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            features.forEach((feature, index) => {
                const item = document.createElement('div');
                item.className = 'feature-item';
                item.setAttribute('role', 'listitem');
                item.innerHTML = `
                    <span>${escapeHtml(feature)}</span>
                    <button class="button-danger" onclick="removeFeature(${index})" aria-label="Remove feature ${escapeHtml(feature)}">Remove</button>
                `;
                fragment.appendChild(item);
            });
            
            listContainer.innerHTML = '';
            listContainer.appendChild(fragment);

            if (removeAllButton) {
                removeAllButton.style.display = 'inline-block';
            }
        }

        // Update next button state
        function updateNextButton() {
            const nextButton = document.getElementById('nextButton');
            nextButton.disabled = features.length === 0;
        }

        function setActivePage(pageId) {
            if (!pageIds.includes(pageId)) {
                console.error('Invalid page ID:', pageId);
                return;
            }

            // Update page visibility
            pageIds.forEach(id => {
                const pageElement = document.getElementById(id);
                if (pageElement) {
                    const isActive = id === pageId;
                    pageElement.classList.toggle('active', isActive);
                    // Update ARIA attributes for accessibility
                    pageElement.setAttribute('aria-hidden', !isActive);
                }
            });

            // Update navigation buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                const target = button.getAttribute('data-target');
                button.classList.toggle('active', target === pageId);
                button.setAttribute('aria-current', target === pageId ? 'page' : 'false');
            });

            // Page-specific logic
            if (pageId === 'page1') {
                const summary = document.getElementById('summary');
                if (summary) {
                    summary.style.display = 'none';
                }
                // Focus management
                const featureInput = document.getElementById('featureInput');
                if (featureInput) {
                    setTimeout(() => featureInput.focus(), 100);
                }
            }

            if (pageId === 'page2') {
                renderRespondentList();
                renderPrioritizationTable();
            }

            if (pageId === 'page3') {
                renderFeatureImportanceChart();
            }
        }

        function navigateToPage(pageId) {
            if (!pageIds.includes(pageId)) {
                return;
            }

            setActivePage(pageId);
        }

        // Navigate to prioritization page with validation
        function goToPrioritization() {
            if (features.length === 0) {
                showNotification('Please add at least one feature first', 'warning');
                return;
            }

            if (!currentRespondentId) {
                showNotification('Please add and select a respondent first', 'warning');
                return;
            }

            setActivePage('page2');
        }

        // Navigate back to entry page
        function goBackToEntry() {
            setActivePage('page1');
        }

        function goToChartPage() {
            setActivePage('page3');
        }

        function goBackToPrioritization() {
            setActivePage('page2');
        }

        // Render the prioritization table with improved security
        function renderPrioritizationTable() {
            const content = document.getElementById('prioritizationContent');
            if (!content) {
                console.error('Prioritization content container not found');
                return;
            }

            if (features.length === 0) {
                content.innerHTML = '<p class="empty-state">No features available. Add features on the previous page.</p>';
                return;
            }
            
            const currentPriorities = getCurrentPriorities();
            
            // Create table using DOM methods for better security
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive';
            
            const table = document.createElement('table');
            table.className = 'prioritization-table';
            table.setAttribute('role', 'table');
            table.setAttribute('aria-label', 'Feature prioritization table');
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const featureHeader = document.createElement('th');
            featureHeader.textContent = 'Feature';
            featureHeader.setAttribute('scope', 'col');
            headerRow.appendChild(featureHeader);
            
            priorityOptions.forEach(option => {
                const th = document.createElement('th');
                th.className = 'priority-cell';
                th.textContent = option.label;
                th.setAttribute('scope', 'col');
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            features.forEach((feature, index) => {
                const row = document.createElement('tr');
                
                const featureCell = document.createElement('td');
                featureCell.className = 'feature-name';
                featureCell.textContent = feature;
                row.appendChild(featureCell);
                
                priorityOptions.forEach(option => {
                    const cell = document.createElement('td');
                    cell.className = 'priority-cell';
                    
                    const label = document.createElement('label');
                    label.className = 'radio-label';
                    
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `priority-${index}`;
                    radio.value = option.id;
                    radio.checked = currentPriorities[feature] === option.id;
                    radio.setAttribute('aria-label', `Set ${feature} priority to ${option.label}`);
                    radio.addEventListener('change', () => updatePriority(feature, option.id));
                    
                    const srSpan = document.createElement('span');
                    srSpan.className = 'sr-only';
                    srSpan.textContent = option.label;
                    
                    label.appendChild(radio);
                    label.appendChild(srSpan);
                    cell.appendChild(label);
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            wrapper.appendChild(table);
            
            // Clear and append
            content.innerHTML = '';
            content.appendChild(wrapper);
        }

        // Update priority for a feature with validation
        function updatePriority(feature, priorityId) {
            // Validate priority ID
            const validPriorityIds = priorityOptions.map(p => p.id);
            if (!validPriorityIds.includes(priorityId)) {
                console.error('Invalid priority ID:', priorityId);
                return;
            }

            // Validate feature exists
            if (!features.includes(feature)) {
                console.error('Feature not found:', feature);
                return;
            }

            const respondent = getCurrentRespondent();
            if (!respondent) {
                showNotification('Please select a respondent first', 'warning');
                return;
            }

            if (!respondent.priorities) {
                respondent.priorities = {};
            }

            respondent.priorities[feature] = priorityId;
            saveData();
            refreshChartIfActive();
        }

        // Show summary
        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const currentPriorities = getCurrentPriorities();

            // Count features by priority for current respondent
            const counts = {
                must: 0,
                should: 0,
                nice: 0,
                not: 0,
                unassigned: 0
            };

            features.forEach(feature => {
                const priority = currentPriorities[feature];
                if (priority) {
                    counts[priority]++;
                } else {
                    counts.unassigned++;
                }
            });

            const currentRespondent = getCurrentRespondent();
            const respondentName = currentRespondent ? currentRespondent.name : 'Unknown';

            const summaryHTML = `
                <h3>Prioritization Summary for ${respondentName}</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">1. Must have</div>
                        <div class="summary-count">${counts.must}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">2. Should have</div>
                        <div class="summary-count">${counts.should}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">3. Nice to have</div>
                        <div class="summary-count">${counts.nice}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">4. Not needed</div>
                        <div class="summary-count">${counts.not}</div>
                    </div>
                    ${counts.unassigned > 0 ? `
                    <div class="summary-item">
                        <div class="summary-label">Unassigned</div>
                        <div class="summary-count" style="color: #dc3545;">${counts.unassigned}</div>
                    </div>
                    ` : ''}
                </div>
            `;

            summaryDiv.innerHTML = summaryHTML;
            summaryDiv.style.display = 'block';
            summaryDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function renderFeatureImportanceChart() {
            const canvas = document.getElementById('featureImportanceChart');
            const wrapper = document.getElementById('chartWrapper');
            const emptyState = document.getElementById('chartEmptyState');

            if (!canvas || !wrapper || !emptyState) {
                return;
            }

            const aggregatedData = features.map(feature => {
                const counts = { must: 0, should: 0, nice: 0, not: 0 };

                respondents.forEach(respondent => {
                    const priority = respondent.priorities ? respondent.priorities[feature] : undefined;
                    if (priority && counts.hasOwnProperty(priority)) {
                        counts[priority]++;
                    }
                });

                return {
                    feature,
                    ...counts
                };
            });

            const totalAssigned = aggregatedData.reduce((sum, data) => sum + data.must + data.should + data.nice + data.not, 0);

            let emptyMessage = '';
            if (features.length === 0) {
                emptyMessage = 'Add features to see the chart.';
            } else if (respondents.length === 0) {
                emptyMessage = 'Add respondents and capture their input to populate this chart.';
            } else if (totalAssigned === 0) {
                emptyMessage = 'No prioritization data yet. Assign priorities to populate this chart.';
            }

            if (emptyMessage) {
                if (featureImportanceChart) {
                    featureImportanceChart.destroy();
                    featureImportanceChart = null;
                }
                canvas.style.display = 'none';
                emptyState.textContent = emptyMessage;
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            canvas.style.display = 'block';

            aggregatedData.sort((a, b) => {
                if (b.must !== a.must) return b.must - a.must;
                if (b.should !== a.should) return b.should - a.should;
                if (b.nice !== a.nice) return b.nice - a.nice;
                return b.not - a.not;
            });

            const labels = aggregatedData.map(item => item.feature);

            const datasetConfigs = [
                { key: 'must', color: 'var(--chart-color-must)' },
                { key: 'should', color: 'var(--chart-color-should)' },
                { key: 'nice', color: 'var(--chart-color-nice)' },
                { key: 'not', color: 'var(--chart-color-not)' }
            ];

            const datasets = datasetConfigs.map(config => {
                const priorityOption = priorityOptions.find(option => option.id === config.key);
                return {
                    label: priorityOption ? priorityOption.label : config.key,
                    data: aggregatedData.map(item => item[config.key]),
                    backgroundColor: config.color,
                    borderWidth: 1,
                    borderColor: '#ffffff',
                    borderRadius: 6,
                    maxBarThickness: 48
                };
            });

            const chartHeight = Math.max(aggregatedData.length * 60, 320);
            wrapper.style.height = `${chartHeight}px`;

            if (featureImportanceChart) {
                featureImportanceChart.destroy();
            }

            featureImportanceChart = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: context => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.x;
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of responses'
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                autoSkip: false
                            }
                        }
                    }
                }
            });
        }

        function refreshChartIfActive() {
            const chartPage = document.getElementById('page3');
            if (chartPage && chartPage.classList.contains('active')) {
                renderFeatureImportanceChart();
            }
        }

        // Export data to Excel with respondents as rows and features as columns
        function exportToExcel() {
            if (!window.XLSX) {
                showNotification('Excel library not loaded. Please refresh the page.', 'error');
                return;
            }

            if (features.length === 0) {
                showNotification('No features to export', 'warning');
                return;
            }

            if (respondents.length === 0) {
                showNotification('No respondents to export', 'warning');
                return;
            }

            try {

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();

            // Prepare data: Respondents as rows, Features as columns
            const data = [];

            // Header row: Respondent | Feature1 | Feature2 | Feature3 | ...
            const headerRow = ['Respondent', ...features];
            data.push(headerRow);

            // Data rows: Each respondent with their priorities for all features
            respondents.forEach(respondent => {
                const row = [respondent.name];

                features.forEach(feature => {
                    const priorityId = respondent.priorities[feature];
                    let priorityLabel = 'Not assigned';

                    if (priorityId) {
                        const priorityOption = priorityOptions.find(p => p.id === priorityId);
                        if (priorityOption) {
                            priorityLabel = priorityOption.label;
                        }
                    }

                    row.push(priorityLabel);
                });

                data.push(row);
            });

            // Create worksheet from data
            const ws = XLSX.utils.aoa_to_sheet(data);

            // Set column widths
            const colWidths = [
                { wch: 25 }, // Respondent column
                ...features.map(() => ({ wch: 25 })) // Feature columns
            ];
            ws['!cols'] = colWidths;

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Prioritization Results');

                // Generate filename with current date
                const date = new Date();
                const filename = `feature-prioritization-${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}.xlsx`;

                // Write and download file
                XLSX.writeFile(wb, filename);
                showNotification('Excel file exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification('Error exporting to Excel. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>
